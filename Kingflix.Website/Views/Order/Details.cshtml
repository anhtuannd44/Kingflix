@using Kingflix.Domain.Enumerables
@model Kingflix.Domain.DomainModel.Order

@{
    ViewBag.Title = "Thông tin đơn hàng";
    Layout = "~/Views/Shared/_ShopLayout.cshtml";
    string base64 = "", imgSrc = "";
    if (Model.Payments.Logo != null)
    {
        base64 = Convert.ToBase64String(Model.Payments.Logo);
        imgSrc = String.Format("data:image/gif;base64,{0}", base64);
    }
}
<div class="bg-light" style="min-height: 75vh">
    <div class="container mb-4">
        <div class="top-checkout row">
            <div class="top-checkout-list col-md-4 col-12">
                <p><i class="number">1</i>Giỏ hàng của bạn</p>
            </div>
            <div class="top-checkout-list col-md-4 d-none d-md-inline">
                <p><i class="number">2</i>Thông tin &amp; Thanh toán</p>
            </div>
            <div class="top-checkout-list col-md-4 d-none d-md-inline active">
                <p id="nk-hoan-tat-don-hang"><i class="number">3</i>Hoàn tất đơn hàng</p>
            </div>
        </div>
    </div>
    <div class="container mb-4">
        <div class="row">
            <div class="col-md-7 col-xs-12">
                <div class="card card-shadow mb-4">
                    <div class="card-body">
                        <h4 class="mb-4">Thông tin đơn hàng <span id="OrderId" class="font-weight-bold small mr-3 text-primary" style="font-size:1rem;">#@Model.OrderId</span></h4>
                        <p class="m-0">
                            Trạng thái:
                            @if (Model.stat == "p")
                            {
                                <span class="badge badge-warning"> Chưa thanh toán </span>
                            }
                            else if (Model.Status == OrderStatus.Done)
                            {
                                <span class="badge badge-success">@OrderStatus.Done.GetEnumDisplayName()</span>
                            }
                            else if (Model.Status == OrderStatus.Pending)
                            {
                                <span class="badge badge-warning">@OrderStatus.Pending.GetEnumDisplayName()</span>
                            }
                            else if (Model.Status == OrderStatus.Cencelled)
                            {
                                <span class="badge badge-danger">@OrderStatus.Cencelled.GetEnumDisplayName()</span>
                            }
                        </p>
                        <hr />
                        @if (Model.TypeOfCategory == TypeOfCategory.Orther)
                        {
                            <table class="table table-hover"
                                   data-toggle="table"
                                   data-search="true"
                                   data-sort-name="name"
                                   data-sort-order="desc"
                                   data-pagination="true"
                                   data-page-size="10">
                                <thead class="">
                                    <tr>
                                        <th class="text-left font-weight-bold" data-sortable="true"> Pic </th>
                                        <th class="text-center font-weight-bold" data-sortable="true"> Gói đăng ký </th>
                                        <th class="text-center font-weight-bold" data-sortable="true"> Số lượng </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.OrderDetails)
                                    {
                                        <tr>
                                            <td class="text-success">
                                                @if (string.IsNullOrEmpty(item.ImageId))
                                                {
                                                    <img class="img-fluid image rounded" src="~/Content/image/No_Picture.jpg">
                                                }
                                                else
                                                {
                                                    <img class="img-fluid image rounded" src="~/Content/Upload/Images/@item.ImageId">
                                                }
                                            </td>
                                            <td class="text-center">
                                                @item.CategoryName (@item.Month tháng)
                                            </td>
                                            <td class="text-center">
                                                @item.Count
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <table class="table table-hover"
                                   data-toggle="table"
                                   data-search="true"
                                   data-sort-name="name"
                                   data-sort-order="desc"
                                   data-pagination="true"
                                   data-page-size="10">
                                <thead class="">
                                    <tr>
                                        <th class="text-center font-weight-bold" data-sortable="true"> Gói đăng ký </th>
                                        <th class="text-center font-weight-bold" data-sortable="true"> Số Profile </th>
                                        <th class="text-center font-weight-bold" data-sortable="true"> Số tháng </th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <tr>
                                        <td class="text-center">
                                            @Model.Categories.Name
                                        </td>
                                        <td class="text-center">
                                            @Model.Profile
                                        </td>
                                        <td class="text-center">
                                            @Model.Month
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-5 col-xs-12">
                <div class="card card-shadow mb-4">
                    <div class="card-body box-payment" id="cartTotal">
                        <table style="width: 100%">
                            <tbody>
                                <tr>
                                    <td class="pb-3" style="text-align:left;font-size: 20px;font-weight: 500;" colspan="2">Tóm tắt đơn hàng</td>
                                </tr>
                                <tr>
                                    <td class="py-1" width="50%">Tạm tính (Chưa VAT):</td>
                                    <td id="totalListedPrice" class="py-1 text-right" width="50%">@string.Format("{0:0,0 đ}", Model.Price)</td>
                                </tr>
                                <tr>
                                    <td class="py-1" width="50%">Phương thức thanh toán:</td>
                                    <td id="totalListedPrice" class="py-1 text-right" width="50%">
                                        <span id="PaymentMethod">@Model.Payments.Name</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-1">Giảm giá:</td>
                                    <td class="py-1 text-right" id="cartDiscount">0 ₫</td>
                                </tr>
                                <tr style="border-top:solid 1px #e7e7e7; line-height: 45px;">
                                    <td>Thành tiền:</td>
                                    <td style="font-size:20px; color:#e82429;font-weight:bold" id="preTotalPrice" class=" text-right">
                                        @string.Format("{0:0,0 đ}", Model.Price)
                                    </td>
                                </tr>
                                <tr class="chonhinhthuc">
                                    <td colspan="2" style="text-align:right">(Đã bao gồm VAT)</td>
                                </tr>

                                <tr class="shonhinhthuc" style="border-bottom:none; display: none;">
                                    <td></td>
                                    <td>(Đã bao gồm VAT)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                @if (Model.stat == "p" && !string.IsNullOrEmpty(Model.PaymentUrl))
                {
                    <div class="mb-4 text-right rounded">
                        <a href="@Model.PaymentUrl" class="btn btn-success btn-block h4 py-3" style="font-size: 1.2rem">
                            Thanh toán ngay
                            <i class="fas fa-arrow-circle-right ml-3"></i>
                        </a>
                    </div>
                }
                else
                {
                    <div class="mb-4 text-right rounded">
                        <a href="@Url.Action("CreateNewPaymentAPI","Order", new {orderId = Model.OrderId })" class="btn btn-success btn-block h4 py-3" style="font-size: 1.2rem">
                            Thanh toán ngay
                            <i class="fas fa-arrow-circle-right ml-3"></i>
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(function () {
    var isSendEmail = "@Model.IsSendMail";
    if (isSendEmail == "False")
        sendEmail();
})

function sendEmail() {
    $.ajax({
        method: "POST",
        url: "/Gmail/SendEmailOrderSuccess",
        data: { orderId: "@Model.OrderId" },
        success: function (data) {
            if (data == "True")
                toastr.success("Kingflix đã gửi thư order đến Email của bạn!")
            else
                toastr.error("Email thông tin order chưa được gửi!")
        },
        error: function () {
        }
    })
        }
        $("#file").change(function () {
            readURL(this);
            var file = $("#file").val();
            if (file != undefined) {
                $("#buttonSubmit").show();
            }
        });
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#previewAvatar').attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

    </script>
} 